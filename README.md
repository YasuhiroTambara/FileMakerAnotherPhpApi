# FileMakerAnotherPhpApi
超軽量 FileMaker CWP Php Api

====

CWP では、レイアウトTO が固定されるような制約がない(そもそもレイアウトが無い)ので、非関連という概念がありません。
どの画面であっても、画面の一部であっても、リスト状にすることも、表型式にすることも、DB側で定義するレイアウト情報からは、完全に自由であるべきです。




## Requirement 【規約と準備】
・公開するデータベースファイルの各ソーステーブルに対し、同名のテーブルオカレンスが１つずつ定義されている事と、同名のレイアウトが１つずつ用意されていることが必要です。
・Sys (※) という名前の特別なソーステーブルを必ず用意し、これにも同名のテーブルオカレンスとレイアウトを作り、必ず1レコードは作ることが必要です。
・Sysには、次のグローバルフィールドを定義します。

Sys::gnCov
Sys::gtRet

それぞれ、
結果セットの該当件数(対象レコード数)、
結果セットから得るJSONテキスト
を返すために用意するものです。

・スクリプトの結果をカスタムwebで取得する事はできないので、上記のグローバルフィールドに結果テキストをセットしてSysレイアウトのレコード情報を返す方法を取りますので、上記の準備が必要です。
・-findany クエリコマンドがSysの1レコードのXMLを返す際に、直前にスクリプトを実行させることで、様々なファイルメーカースクリプトの実行結果を得る仕組みです。



## Demo
FOODWEB.fmp12 というサンプルをファイルメーカーサーバーの所定のDatabasesフォルダに配置し、
ウェブサイト以下には、sampleフォルダを配置してindex.phpにアクセスしてご確認ください。
このDBファイルは、上記の規約に沿っています。
また、JSON生成スクリプトで使っているカスタム関数や、検索スクリプトの仕様については別添のPDFに記載します。


## Usage
スクリプトを実行させる関数 Perform を使い様々なファイルメーカースクリプトを実行できます。

（例）
<?php
$API = new API($host,$file,$acc,$pas);        //新規当該クラスのオブジェクト
$rtn =$API->Perform(<スクリプト名>,<引数のテキスト>);  //戻り値は php連想配列オブジェクト
$cov =$rtn['gnCov'];                          //結果セットの該当件数(対象レコード数)
$ret =$rtn['gtRet'];                          //結果セットから得るJSONテキスト
?>



## Checker
● チェッカーるフォルダに含まれている以下の2ファイルは、このAPIが正しくデータベースサーバーに問い合わせできる状態かどうかを検証する際にお使いいただくページです。
dbs.php
db.php

● dbs.php : 問い合わせ可能なデータベースファイル名のリストをブラウザのウィンドウ内にリストします。
・※公式ApiForPhp の ListDatabases() に相当します。

● db.php : データベースファイル名を指定してレイアウト名、スクリプト名をブラウザのウィンドウ内にリストします。
url引数として以下の3つの値が必須です。
db  : データベースファイル名
acc : アカウント名
pas : パスワード
・※公式ApiForPhp の ListScripts(),ListLayout() に相当します。
（例）http://127.0.0.1/siteroot/..../checkers/db.php?db=***&acc=***&pas=***

● このディレクトリ checkers は、実運用環境からは削除するようにしてください。



## Author
[Yasuhiro Tambara](https://github.com/YasuhiroTambara)
